@page "/submit-testimonial"
@inject ITestimonialService TestimonialService
@inject NavigationManager NavManager
@layout UserLayout
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Forms

<h2 class="text-3xl font-semibold mb-6 text-center">Submit Your Testimonial</h2>

<EditForm Model="@testimonial" OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-4">
        <label class="block mb-2 text-sm font-medium text-gray-700">Your Name</label>
        <InputText class="w-full px-4 py-2 border rounded shadow-sm" @bind-Value="testimonial.Author" placeholder="Enter your name" />
    </div>

    <div class="mb-4">
        <label class="block mb-2 text-sm font-medium text-gray-700">Title</label>
        <InputText class="w-full px-4 py-2 border rounded shadow-sm" @bind-Value="testimonial.Title" placeholder="E.g. Happy Customer" />
    </div>

    <div class="mb-4">
        <label class="block mb-2 text-sm font-medium text-gray-700">Your Role</label>
        <InputText class="w-full px-4 py-2 border rounded shadow-sm" @bind-Value="testimonial.AuthorRole" placeholder="e.g. Developer, Teacher" />
    </div>

    <div class="mb-4">
        <label class="block mb-2 text-sm font-medium text-gray-700">Country</label>
        <InputSelect class="w-full px-4 py-2 border rounded shadow-sm" @bind-Value="testimonial.CountryCode">
            <option value="">Select country</option>
            <option value="PK">🇵🇰 Pakistan</option>
            <option value="US">🇺🇸 United States</option>
            <option value="IN">🇮🇳 India</option>
            <option value="UK">🇬🇧 United Kingdom</option>
            <option value="SA">🇸🇦 Saudi Arabia</option>
            <option value="CA">🇨🇦 Canada</option>
        </InputSelect>
    </div>

    <div class="mb-4">
        <label class="block mb-2 text-sm font-medium text-gray-700">Rating</label>
        <InputSelect class="w-full px-4 py-2 border rounded shadow-sm" @bind-Value="testimonial.Rating">
            <option value="">Select rating</option>
            @for (int i = 1; i <= 5; i++)
            {
                <option value="@i">@i Star(s)</option>
            }
        </InputSelect>
    </div>

    <div class="mb-4">
        <label class="block mb-2 text-sm font-medium text-gray-700">Upload Your Photo</label>
        <InputFile OnChange="HandleImageUpload" accept="image/*" class="w-full" />
    </div>

    @if (!string.IsNullOrEmpty(imagePreview))
    {
        <div class="mb-4 text-center">
            <img src="@imagePreview" alt="Preview" class="w-24 h-24 rounded-full mx-auto shadow-md border border-gray-300" />
        </div>
    }

    <div class="mb-4">
        <label class="block mb-2 text-sm font-medium text-gray-700">Your Message</label>
        <InputTextArea class="w-full px-4 py-2 border rounded shadow-sm h-32 resize-none"
                       @bind-Value="testimonial.Message" placeholder="Write your testimonial..." />
    </div>

    <button type="submit"
            class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded shadow-md transition transform hover:-translate-y-1">
        Submit
    </button>

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="mt-4 text-center text-green-600 font-medium">
            @statusMessage
        </div>
    }
</EditForm>

@code {
    private TestimonialModel testimonial = new();
    private string statusMessage = string.Empty;
    private string? imagePreview;

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            var buffer = new byte[file.Size];
            await file.OpenReadStream(maxAllowedSize: 2 * 1024 * 1024).ReadAsync(buffer); // Max 2MB
            imagePreview = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
            testimonial.AuthorImageUrl = imagePreview;
        }
    }

    private async Task HandleSubmit()
    {
        await TestimonialService.AddTestimonialAsync(testimonial);
        statusMessage = "Thank you! Your testimonial has been submitted for admin approval.";
        testimonial = new();
        imagePreview = null;
    }
}
